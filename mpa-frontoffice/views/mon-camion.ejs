<div class="container py-4">
  <h2 class="mb-4">Mon camion</h2>
  <div id="truckSection">
    <div id="reserveZone" class="mb-3">
      <label class="form-label">Réserver un camion disponible</label>
      <div class="d-flex gap-2">
        <select id="availableTrucks" class="form-select" style="max-width:360px"></select>
        <button id="reserveBtn" class="btn btn-success">Réserver</button>
      </div>
      <div id="reserveMsg" class="mt-2"></div>
    </div>

    <div id="myTruck" class="card d-none">
      <div class="card-body">
        <h5 class="card-title">Camion attribué: <span id="truckName"></span></h5>
        <div class="row g-3">
          <div class="col-md-8">
            <label class="form-label">Mettre à jour l'adresse du camion</label>
            <div class="input-group">
              <input id="truckAddress" class="form-control" placeholder="Saisir une adresse">
              <button id="locateBtn" class="btn btn-outline-secondary" type="button">Localiser</button>
            </div>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button id="confirmAddrBtn" class="btn btn-primary w-100 d-none" type="button">Confirmer la nouvelle adresse</button>
          </div>
          <div class="col-12">
            <div id="truckMap" style="height:260px;border:1px solid #dee2e6;border-radius:8px;"></div>
          </div>
        </div>
        <hr>
        <h6>Déclarer un incident</h6>
        <div class="row g-2">
          <div class="col-md-3">
            <select id="incidentType" class="form-select">
              <option value="panne">Panne</option>
              <option value="entretien">Entretien</option>
              <option value="reparation">Réparation</option>
            </select>
          </div>
          <div class="col-md-4">
            <input id="incidentTitle" class="form-control" placeholder="Titre">
          </div>
          <div class="col-md-5">
            <input id="incidentDesc" class="form-control" placeholder="Description (optionnelle)">
          </div>
          <div class="col-12">
            <button id="reportIncidentBtn" class="btn btn-warning mt-2">Déclarer</button>
          </div>
        </div>
        <hr>
        <button id="releaseBtn" class="btn btn-outline-danger">Rendre le camion</button>
        <div id="truckMsg" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  const api = 'https://api.axia.quest';
  let map = null; let marker = null; let lastGeocode = null;
  async function fetchJSON(url, opts={}){
    const res = await fetch(url, Object.assign({ credentials: 'include', headers: { 'Content-Type': 'application/json' } }, opts));
    const data = await res.json().catch(()=>({}));
    if (!res.ok) throw new Error(data.error || 'Erreur réseau');
    return data;
  }
  async function load(){
    const me = await fetchJSON(api + '/api/auth/me');
    if (!me.user || me.user.role !== 'franchisé') { window.location.href = '/'; return; }
    const all = await (await fetch(api + '/api/trucks', { credentials:'include' })).json();
    const mine = all.find(t=>t.franchisee_user_id === me.user.id);
    const select = document.getElementById('availableTrucks');
    let avail = [];
    try {
      avail = await fetchJSON(api + '/api/trucks/available');
    } catch(e) {
      // fallback si indisponible
      avail = all.filter(t=>!t.franchisee_user_id && t.active === 1);
    }
    select.innerHTML = avail.length ? avail.map(t=>`<option value="${t.id}">${t.name}</option>`).join('') : '<option value="">Aucun camion disponible</option>';
    const myTruckCard = document.getElementById('myTruck');
    if (mine){
      myTruckCard.classList.remove('d-none');
      document.getElementById('truckName').innerText = mine.name;
      // Masquer la zone de réservation
      document.getElementById('reserveZone').classList.add('d-none');
      // Init carte
      ensureLeaflet().then(()=>{
        initMap(mine.lat || 48.8566, mine.lng || 2.3522, mine.address || '');
      });
      myTruckCard.dataset.id = mine.id;
    } else {
      myTruckCard.classList.add('d-none');
      document.getElementById('reserveZone').classList.remove('d-none');
      delete myTruckCard.dataset.id;
    }
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    load();
    document.getElementById('reserveBtn').addEventListener('click', async ()=>{
      const id = document.getElementById('availableTrucks').value;
      if (!id) { document.getElementById('reserveMsg').innerText = 'Aucun camion disponible'; return; }
      try {
        await fetchJSON(api + '/api/trucks/' + id + '/reserve', { method:'POST' });
        document.getElementById('reserveMsg').innerText = 'Camion réservé !';
        load();
      } catch(e){ document.getElementById('reserveMsg').innerText = e.message; }
    });
    // Géocodage et carte
    document.getElementById('locateBtn').addEventListener('click', async ()=>{
      const addr = document.getElementById('truckAddress').value.trim();
      if (!addr) return;
      try {
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
        const j = await r.json();
        if (!Array.isArray(j) || !j.length) { document.getElementById('truckMsg').innerText = 'Adresse introuvable'; return; }
        const { lat, lon, display_name } = j[0];
        lastGeocode = { lat: parseFloat(lat), lng: parseFloat(lon), address: display_name };
        ensureLeaflet().then(()=>{
          initMap(lastGeocode.lat, lastGeocode.lng, lastGeocode.address);
        });
        document.getElementById('confirmAddrBtn').classList.remove('d-none');
        document.getElementById('truckMsg').innerText = '';
      } catch(e){ document.getElementById('truckMsg').innerText = 'Erreur de géocodage'; }
    });
    document.getElementById('confirmAddrBtn').addEventListener('click', async ()=>{
      const card = document.getElementById('myTruck');
      const id = card.dataset.id;
      if (!id || !lastGeocode) return;
      try {
        await fetchJSON(api + '/api/trucks/' + id + '/location', { method:'POST', body: JSON.stringify({ lat:lastGeocode.lat, lng:lastGeocode.lng }) });
        // Mise à jour adresse en base côté truck: utiliser PUT truck pour stocker l'adresse si souhaité
        await fetchJSON(api + '/api/trucks/' + id, { method:'PUT', body: JSON.stringify({ address: lastGeocode.address }) });
        document.getElementById('truckMsg').innerText = 'Adresse mise à jour';
        document.getElementById('confirmAddrBtn').classList.add('d-none');
      } catch(e){ document.getElementById('truckMsg').innerText = e.message; }
    });
    document.getElementById('reportIncidentBtn').addEventListener('click', async ()=>{
      const card = document.getElementById('myTruck');
      const id = card.dataset.id;
      const type = document.getElementById('incidentType').value;
      const title = document.getElementById('incidentTitle').value.trim();
      const description = document.getElementById('incidentDesc').value.trim();
      if (!id || !type || !title) { document.getElementById('truckMsg').innerText = 'Type et titre requis'; return; }
      try {
        await fetchJSON(api + '/api/incidents', { method:'POST', body: JSON.stringify({ truck_id: Number(id), type, title, description }) });
        document.getElementById('truckMsg').innerText = 'Incident déclaré';
        document.getElementById('incidentTitle').value = '';
        document.getElementById('incidentDesc').value = '';
      } catch(e){ document.getElementById('truckMsg').innerText = e.message; }
    });
    document.getElementById('releaseBtn').addEventListener('click', async ()=>{
      const card = document.getElementById('myTruck');
      const id = card.dataset.id;
      if (!id) return;
      try {
        await fetchJSON(api + '/api/trucks/' + id + '/release', { method:'POST' });
        document.getElementById('truckMsg').innerText = 'Camion rendu';
        load();
      } catch(e){ document.getElementById('truckMsg').innerText = e.message; }
    });
  });
  function ensureLeaflet(){
    return new Promise((resolve)=>{
      if (window.L) return resolve();
      const css = document.createElement('link'); css.rel='stylesheet'; css.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'; document.head.appendChild(css);
      const s = document.createElement('script'); s.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'; s.onload=()=>resolve(); document.body.appendChild(s);
    });
  }
  function initMap(lat, lng, label){
    const L = window.L;
    if (!map){ map = L.map('truckMap').setView([lat, lng], 14); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map); }
    else { map.setView([lat, lng], 14); }
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map).bindPopup(label||'').openPopup();
  }
})();
</script>


